services:
  openclaw:
    image: openclaw-client:latest
    container_name: openclaw-ross

    entrypoint: ["/home/openclaw/entrypoint.sh"]
    command: ["openclaw", "gateway", "--bind", "lan"]

    extra_hosts:
      - "host.docker.internal:host-gateway"

    user: "1000:1000"

    volumes:
      - ./workspace:/home/openclaw/.openclaw/workspace:rw,noexec
      - ./openclaw.json:/home/openclaw/.openclaw/openclaw.json:rw
      - ./entrypoint.sh:/home/openclaw/entrypoint.sh:ro
      - ./canvas:/home/openclaw/.openclaw/canvas:rw,noexec
      - ./data/agents:/home/openclaw/.openclaw/agents:rw
      - ./data/cron:/home/openclaw/.openclaw/cron:rw
      - ./data/credentials:/home/openclaw/.openclaw/credentials:rw

    tmpfs:
      - /tmp:size=100M,noexec,nosuid,nodev
      - /var/tmp:size=50M,noexec,nosuid,nodev

    secrets:
      - telegram_token
      - gateway_token

    environment:
      - CLIENT_NAME=ross
      - NODE_ENV=production

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
          pids: 100
        reservations:
          cpus: '0.25'
          memory: 512M

    networks:
      - client-network

    ports:
      - "127.0.0.1:19789:18789"

    privileged: false
    cap_drop:
      - ALL

    security_opt:
      - no-new-privileges:true

    sysctls:
      - net.ipv4.ip_forward=0
      - net.ipv4.conf.all.send_redirects=0
      - net.ipv4.conf.all.accept_redirects=0

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "client-ross"

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:18789/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  client-network:
    driver: bridge

secrets:
  telegram_token:
    file: ./secrets/telegram_token.txt
  gateway_token:
    file: ./secrets/gateway_token.txt
