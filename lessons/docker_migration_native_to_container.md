# Docker Migration: Moving a Native OpenClaw Bot to Docker Container

**Date:** 2026-02-10  
**Author:** Antigravity  
**Case Study:** Ross (native → Docker migration)  
**Applies to:** Any OpenClaw bot being migrated or deployed in Docker  

---

## Context

We run multiple OpenClaw bots on a single Hostinger VPS (72.62.252.124):
- **Jack** — primary bot, runs **native** (directly on host OS)
- **John** — secondary bot, runs in **Docker** (was set up using custom docker-compose)
- **Ross** — secondary bot, was running **native** alongside Jack, causing CLI conflicts

Ross was moved from native to Docker to eliminate gateway/CLI conflicts with Jack. This document records every problem encountered and the fixes applied.

---

## Why We Migrated

Running two native OpenClaw instances on the same host causes:
1. **CLI confusion** — one global `openclaw` binary, `OPENCLAW_HOME` env var doesn't fully isolate
2. **Gateway port conflicts** — both try to bind to default port
3. **Systemd confusion** — `openclaw gateway stop` stops the wrong bot
4. **Session cross-contamination** — `openclaw status` shows the wrong bot's data

Docker solves all of these by giving each bot its own isolated filesystem and process space.

---

## Our Approach vs Official OpenClaw Docker Docs

### Official Method (docs.openclaw.ai/install/docker)

OpenClaw's official Docker method is designed for **fresh installs**:

```bash
# Official: Fresh install using their setup script
./docker-setup.sh
```

This script:
- Builds the gateway image from source
- Runs the onboarding wizard inside Docker
- Generates a gateway token
- Creates a docker-compose.yml
- Starts the gateway

**Key assumptions:**
- You're starting from scratch (no existing config)
- The container user is `node` (uid 1000)
- The home directory is `/home/node/.openclaw/`
- Permissions fix: `sudo chown -R 1000:1000 /path/to/config`

### Our Method (Migration of Existing Bot)

We needed to **migrate an existing, configured bot** — not start fresh. This meant:
- Preserving the existing `openclaw.json` config
- Preserving workspace files (SOUL.md, AGENTS.md, memory, etc.)
- Preserving session history
- Preserving channel connections (Telegram, WhatsApp)

We used John's working Docker setup as a template, copied Ross's files in, and adjusted.

### How Far We Deviated

| Aspect | Official Method | Our Method | Deviation Level |
|---|---|---|---|
| Image | Built from source | Used pre-existing `openclaw-client:latest` | Moderate |
| Onboarding | `docker-setup.sh` wizard | Skipped — config already exists | High |
| Config | Generated fresh | Copied from native install | High |
| Home dir user | `node` | `openclaw` (our custom image) | Low |
| Permissions | `chown 1000:1000` | `chown 101000:101000` (userns remap) | **Critical** |
| Config mount | Not specified (uses volume) | Bind mount from host | Low |
| docker-compose | Generated by setup script | Hand-crafted based on John's | Moderate |

**Overall deviation: Significant.** The official method doesn't cover migration scenarios at all.

---

## Every Problem Encountered (In Order)

### Problem 1: Accidentally Stopped Jack's Gateway
**What happened:** Running `OPENCLAW_HOME=/root/.openclaw-ross openclaw gateway stop` stopped Jack's systemd service instead of Ross's.  
**Root cause:** The `openclaw gateway stop` command uses systemd, which has one global service — it doesn't respect `OPENCLAW_HOME`.  
**Fix:** Restarted Jack with `openclaw gateway start`. Killed Ross's process manually with `pkill -f 'gateway --port 19789'`.  
**Lesson:** Never use `openclaw gateway stop` when multiple native instances exist. Kill the process directly.

### Problem 2: Invalid Config Key (`heartbeat.enabled`)
**What happened:** Ross's config had `agents.defaults.heartbeat.enabled` — a key that doesn't exist in the current OpenClaw version.  
**Root cause:** The key was likely valid in an older version and carried forward.  
**Fix:** Removed the key via Python script on the host.  
**Lesson:** Always run `openclaw doctor` on migrated configs before starting the container.

### Problem 3: `dmPolicy: "open"` Requires `allowFrom: ["*"]`
**What happened:** We changed `dmPolicy` from `"pairing"` to `"open"` so Coach could DM Ross. But OpenClaw requires `allowFrom: ["*"]` when dmPolicy is open.  
**Root cause:** Config validation rule — `open` dmPolicy means "anyone can DM" which requires `allowFrom` to explicitly include wildcard.  
**Fix:** Added `"allowFrom": ["*"]` to telegram config.  
**Lesson:** When changing dmPolicy, always check the corresponding allowFrom. They're coupled.

### Problem 4: `openclaw doctor --fix` Fails on Read-Only Config Mount
**What happened:** Config was mounted as `:ro` (read-only) in docker-compose. Doctor couldn't write fixes.  
**Root cause:** We copied John's security-hardened setup which mounts config read-only.  
**Fix:** Changed to `:rw` in docker-compose.yml. Then ran doctor with a temporary container (`docker run --rm --user root`).  
**Lesson:** For initial setup, mount config as `:rw`. After config is stable, switch to `:ro` for security.

### Problem 5: `EBUSY` When Doctor Tries to Write Config
**What happened:** Even with `:rw`, running `openclaw doctor --fix` inside the running container got `EBUSY: resource busy`.  
**Root cause:** The gateway process had the config file open/locked.  
**Fix:** Stopped the container first, ran doctor in a temporary container, then restarted.  
**Lesson:** Config file modifications must be done with the gateway stopped. Use:
```bash
docker compose down
docker run --rm --user root -v /path/to/config.json:/home/openclaw/.openclaw/openclaw.json:rw openclaw-client:latest openclaw doctor --fix
docker compose up -d
```

### Problem 6: `EACCES: permission denied, mkdir sessions`
**What happened:** Gateway started but crashed when trying to create session directories.  
**Root cause:** Files were owned by `root:root` (from the `cp` command). Container runs as uid 1000.  
**Fix:** `chown -R 1000:1000` on all data directories.  
**Lesson (PARTIAL):** This fix was incomplete — see Problem 9 for the real solution.

### Problem 7: Hardcoded Old Paths in `sessions.json`
**What happened:** Error pointed to `/root/.openclaw-ross/agents/main/sessions` — the OLD native path.  
**Root cause:** The `sessions.json` store file contained 19 references to the old native path. The agent tried to create directories at the old location.  
**Fix:** `sed -i 's|/root/.openclaw-ross/|/home/openclaw/.openclaw/|g' sessions.json`  
**Lesson:** When migrating, ALL path references in session and workspace files must be updated. The key files to check:
- `agents/main/sessions/sessions.json` — stores session metadata with absolute paths
- `workspace/*.md` — may contain path references
- `agents/main/sessions/*.jsonl` — may contain tool call paths

### Problem 8: Workspace `.md` Files Have Old Path References
**What happened:** Similar to Problem 7 but in workspace markdown files.  
**Root cause:** The workspace files were copied verbatim from the native install.  
**Fix:** `find workspace -name '*.md' -exec sed -i 's|/root/.openclaw-ross/|/home/openclaw/.openclaw/|g' {} +`  
**Lesson:** Always do a global search-replace for old paths after copying workspace files.

### Problem 9: `EPERM: chmod auth-profiles.json` — The UID Remapping Problem ⚠️
**What happened:** After fixing ownership to `1000:1000`, still got `EPERM` (operation not permitted) on chmod operations.  
**Root cause:** **Docker user namespace remapping is enabled on this server.** When userns-remap is active, uid 1000 inside the container maps to uid **101000** on the host. Files owned by host uid 1000 are NOT writable by the container's uid 1000.  
**Fix:** `chown -R 101000:101000 /root/openclaw-clients/ross/`  
**How we discovered it:** Compared John's working file ownership (`101000:101000`) with Ross's (`1000:1000`).  

**This is the most important lesson from the entire migration:**

```
THE OFFICIAL DOCS SAY: sudo chown -R 1000:1000 /path/to/config
THE REALITY ON OUR SERVER: chown -R 101000:101000 /path/to/config

BECAUSE: Docker user namespace remapping is enabled.
```

**How to detect userns-remap:**
```bash
# Check if userns-remap is configured
grep userns /etc/docker/daemon.json
# Or check the remapped UID range
cat /etc/subuid
# Or just look at a working container's file ownership
stat -c '%u:%g' /root/openclaw-clients/john/workspace/SOUL.md
```

---

## Complete Correct Migration Procedure

For future reference, here's the procedure that would have worked first try:

```bash
# 1. Stop the native bot
pkill -f 'gateway --port <PORT>'

# 2. Create directory structure
mkdir -p /root/openclaw-clients/<botname>/{workspace,data/agents,data/cron,data/credentials,secrets,canvas}

# 3. Copy files
cp -a /root/.openclaw-<botname>/workspace/. /root/openclaw-clients/<botname>/workspace/
cp /root/.openclaw-<botname>/openclaw.json /root/openclaw-clients/<botname>/openclaw.json
cp -a /root/.openclaw-<botname>/agents/. /root/openclaw-clients/<botname>/data/agents/
cp -a /root/.openclaw-<botname>/credentials/. /root/openclaw-clients/<botname>/data/credentials/
cp -a /root/.openclaw-<botname>/canvas/. /root/openclaw-clients/<botname>/canvas/

# 4. Fix ALL old path references (CRITICAL)
find /root/openclaw-clients/<botname>/ -type f \( -name '*.json' -o -name '*.jsonl' -o -name '*.md' \) \
  -exec sed -i 's|/root/.openclaw-<botname>/|/home/openclaw/.openclaw/|g' {} +

# 5. Extract tokens to secrets files
python3 -c "import json; c=json.load(open('/root/openclaw-clients/<botname>/openclaw.json')); print(c['channels']['telegram']['botToken'])" > secrets/telegram_token.txt
python3 -c "import json; c=json.load(open('/root/openclaw-clients/<botname>/openclaw.json')); print(c['gateway']['auth']['token'])" > secrets/gateway_token.txt

# 6. Update config for Docker
python3 -c "
import json
c = json.load(open('/root/openclaw-clients/<botname>/openclaw.json'))
c['gateway']['bind'] = 'lan'
c['gateway']['port'] = 18789
c['agents']['defaults']['workspace'] = '/home/openclaw/.openclaw/workspace'
json.dump(c, open('/root/openclaw-clients/<botname>/openclaw.json','w'), indent=2)
"

# 7. Run doctor to fix any invalid keys (with gateway stopped)
docker run --rm --user root \
  -v /root/openclaw-clients/<botname>/openclaw.json:/home/openclaw/.openclaw/openclaw.json:rw \
  openclaw-client:latest openclaw doctor --fix

# 8. Copy docker-compose.yml from John (or create from template)
cp /root/openclaw-clients/john/docker-compose.yml /root/openclaw-clients/<botname>/
# Edit: change container_name, CLIENT_NAME, port mapping

# 9. Copy entrypoint.sh from John
cp /root/openclaw-clients/john/entrypoint.sh /root/openclaw-clients/<botname>/

# 10. Fix ownership — CHECK FOR USERNS REMAP FIRST!
OWNER_UID=$(stat -c '%u' /root/openclaw-clients/john/workspace/SOUL.md)
chown -R $OWNER_UID:$OWNER_UID /root/openclaw-clients/<botname>/

# 11. Set secret file permissions
chmod 600 /root/openclaw-clients/<botname>/secrets/*
chmod +x /root/openclaw-clients/<botname>/entrypoint.sh

# 12. Start
cd /root/openclaw-clients/<botname>
docker compose up -d

# 13. Verify — check for ANY errors
sleep 15
docker logs <container-name> 2>&1 | grep -i 'error\|EACCES\|EPERM\|permission\|fail'
```

---

## Analysis: Official Docker Method vs Our Method

### Would Following the Official Method Have Been Better?

**For a FRESH bot: YES, absolutely.**

The official `./docker-setup.sh` handles:
- Image building
- Onboarding wizard (creates clean config)
- Gateway token generation
- docker-compose generation
- All paths are correct from the start
- No migration needed

**For MIGRATING an existing bot: NO, the official method doesn't cover this.**

The official docs have **zero guidance** on:
- How to migrate a native install to Docker
- How to handle existing session files with hardcoded paths
- How to deal with user namespace remapping (they say `chown 1000:1000` which is wrong when userns-remap is active)
- How to run `openclaw doctor --fix` when the config is bind-mounted
- How to handle the `dmPolicy` + `allowFrom` coupling

### Recommendation for Future Bots

| Scenario | Best Approach |
|---|---|
| **Brand new bot** | Use official `./docker-setup.sh` |
| **Migrating native → Docker** | Use this lesson's procedure (Step 1-13 above) |
| **Cloning an existing Docker bot** | Copy the working Docker bot's directory, change tokens/config |

### The Key Gotcha: User Namespace Remapping

This is the #1 thing the official docs get wrong for our setup. If you see `EACCES` or `EPERM` after following their `chown 1000:1000` advice, check:

```bash
# What UID does a working container actually use on the host?
stat -c '%u' /root/openclaw-clients/john/workspace/SOUL.md
# If it says 101000 instead of 1000, userns-remap is active
```

**Always match the working container's UID, never blindly follow docs.**

---

## Quick Reference Checklist

When creating any new Docker OpenClaw bot:

- [ ] Stop any native instance first
- [ ] Create directory structure following John's layout
- [ ] Copy config and workspace files
- [ ] **Replace ALL old path references** (`/root/.openclaw-xxx/` → `/home/openclaw/.openclaw/`)
- [ ] Extract tokens to secrets files
- [ ] Update config: `gateway.bind = "lan"`, `gateway.port = 18789`
- [ ] Run `openclaw doctor --fix` with gateway stopped
- [ ] Create docker-compose.yml (copy from John, change container name + port)
- [ ] **Set ownership to `101000:101000`** (NOT `1000:1000` — userns-remap!)
- [ ] Start with `docker compose up -d`
- [ ] Check logs for ANY errors: `docker logs <name> 2>&1 | grep -i error`
- [ ] Test by sending a message on Telegram/WhatsApp
